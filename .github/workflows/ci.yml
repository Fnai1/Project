name: 1C CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  CONFIG_NAME: "andreym"

jobs:
  build:
    name: 🔨 Build
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Build configuration
        shell: pwsh
        run: |
          # Создаем структуру
          New-Item -ItemType Directory -Path "build" -Force
          New-Item -ItemType Directory -Path "backups" -Force
          
          # Создаем CF файл
          $cfFile = "build/${{ env.CONFIG_NAME }}.cf"
          echo "# 1C Configuration" > $cfFile
          echo "Name: ${{ env.CONFIG_NAME }}" >> $cfFile
          echo "Version: 1.0" >> $cfFile
          echo "Date: $(Get-Date)" >> $cfFile
          echo "✅ CF file created: $cfFile"
          
          # Создаем backup
          $backupFile = "backups/${{ env.CONFIG_NAME }}-$(Get-Date -Format 'yyyyMMdd-HHmmss').cf"
          Copy-Item $cfFile $backupFile
          echo "✅ Backup created: $backupFile"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 1c-build
          path: |
            build/
            backups/
          retention-days: 30

  test:
    name: ✅ Test
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: 1c-build
          path: .  # Важно: скачиваем в текущую директорию
      
      - name: Test configuration
        shell: pwsh
        run: |
          echo "Looking for CF files..."
          echo "Current directory: $PWD"
          echo "All files:"
          Get-ChildItem -Recurse | Format-Table FullName
          
          # Ищем файлы в правильных местах
          $cfFile = "build/${{ env.CONFIG_NAME }}.cf"
          $backupFiles = Get-ChildItem -Path "backups" -Filter "${{ env.CONFIG_NAME }}-*.cf" -ErrorAction SilentlyContinue
          
          if (Test-Path $cfFile) {
            echo "✅ MAIN CF file found: $cfFile"
            echo "Content:"
            Get-Content $cfFile
            echo ""
          } else {
            echo "❌ Main CF file not found: $cfFile"
          }
          
          if ($backupFiles) {
            echo "✅ BACKUP files found ($($backupFiles.Count)):"
            $backupFiles | ForEach-Object { echo "  - $($_.Name)" }
          } else {
            echo "⚠ No backup files found"
          }
          
          # Проверяем что хотя бы один файл есть
          if ((Test-Path $cfFile) -or $backupFiles) {
            echo "✅ TEST PASSED: Files created successfully"
          } else {
            echo "❌ TEST FAILED: No CF files found"
            exit 1
          }
