name: 1C CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Ручной запуск
    inputs:
      environment:
        description: "Deploy environment"
        required: true
        default: "test"
        type: choice
        options:
          - test
          - production

env:
  CONFIG_NAME: "andreym"
  BUILD_DIR: "artifacts/build"
  BACKUP_DIR: "artifacts/backups"
  LOGS_DIR: "artifacts/logs"

jobs:
  init:
    name: 🚀 Initialize
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PowerShell
        shell: pwsh
        run: |
          echo "PowerShell version: $($PSVersionTable.PSVersion)"
          echo "Setting execution policy..."
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
      
      - name: Create directories
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path ${{ env.BUILD_DIR }} -Force
          New-Item -ItemType Directory -Path ${{ env.BACKUP_DIR }} -Force
          New-Item -ItemType Directory -Path ${{ env.LOGS_DIR }} -Force
          echo "Directories created"
          
      - name: List project structure
        shell: pwsh
        run: |
          echo "Project structure:"
          Get-ChildItem -Recurse | Select-Object Name, FullName | Format-Table -AutoSize

  build:
    name: 🔨 Build Configuration
    runs-on: windows-latest
    needs: init
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run 1C build script
        shell: pwsh
        env:
          V8_REPOSITORY_PATH: ${{ secrets.V8_REPOSITORY_PATH }}
        run: |
          echo "Running 1C build script..."
          .\scripts\build-1c.ps1 -ConfigName "${{ env.CONFIG_NAME }}" -OutputDir "${{ env.BUILD_DIR }}"
          
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: 1c-build-output
          path: |
            ${{ env.BUILD_DIR }}/
            ${{ env.BACKUP_DIR }}/
          retention-days: 30

  test:
    name: ✅ Test Configuration
    runs-on: windows-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: 1c-build-output
      
      - name: Run tests
        shell: pwsh
        run: |
          $cfFile = "${{ env.BUILD_DIR }}/${{ env.CONFIG_NAME }}.cf"
          
          if (Test-Path $cfFile) {
            echo "✅ CF file exists"
            echo "File information:"
            Get-Item $cfFile | Format-List *
            
            echo "Content preview:"
            Get-Content $cfFile -First 10
            
            # Проверка размера
            $sizeKB = (Get-Item $cfFile).Length / 1KB
            if ($sizeKB -gt 1) {
              echo "✅ File size OK: $([math]::Round($sizeKB, 2)) KB"
            } else {
              echo "⚠ File is too small"
            }
          } else {
            echo "❌ CF file not found"
            exit 1
          }

  deploy:
    name: 🚀 Deploy Configuration
    runs-on: windows-latest
    needs: test
    if: github.event_name == 'workflow_dispatch'  # Только ручной запуск
    environment: ${{ github.event.inputs.environment || 'test' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: 1c-build-output
      
      - name: Deploy configuration
        shell: pwsh
        env:
          V8_USER: ${{ secrets.V8_USER }}
          V8_PASSWORD: ${{ secrets.V8_PASSWORD }}
        run: |
          $environment = "${{ github.event.inputs.environment || 'test' }}"
          $server = if ($environment -eq "production") {
            "${{ secrets.V8_PROD_SERVER }}"
          } else {
            "${{ secrets.V8_TEST_SERVER }}"
          }
          
          $infobase = if ($environment -eq "production") {
            "${{ env.CONFIG_NAME }}"
          } else {
            "${{ env.CONFIG_NAME }}_TEST"
          }
          
          .\scripts\deploy-1c.ps1 `
            -CFFile "${{ env.BUILD_DIR }}/${{ env.CONFIG_NAME }}.cf" `
            -Server $server `
            -InfobaseName $infobase `
            -Environment $environment
      
      - name: Upload deployment logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deployment-logs-${{ github.run_number }}
          path: ${{ env.LOGS_DIR }}/
          retention-days: 90
