name: 1C CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      config_name:
        description: '–ò–º—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (CF-—Ñ–∞–π–ª–∞)'
        required: false
        default: 'config'
        type: string

env:
  CONFIG_NAME: ${{ github.event.inputs.config_name || 'config' }}
  ONEC_PLATFORM: ${{ secrets.ONEC_PLATFORM }}
  STORAGE: ${{ secrets.STORAGE }}
  STORAGE_USER: ${{ secrets.STORAGE_USER }}
  STORAGE_PWD: ${{ secrets.STORAGE_PWD }}
  TEST_IB_CONN: ${{ secrets.TEST_IB_CONN }}
  TEST_IB_USER: ${{ secrets.TEST_IB_USER }}
  TEST_IB_PWD: ${{ secrets.TEST_IB_PWD }}
  PUBLISH_URL: ${{ secrets.PUBLISH_URL }}

jobs:
  build:
    name: üî® –°–±–æ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–æ–≤
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "artifacts/build" -Force | Out-Null
          New-Item -ItemType Directory -Path "artifacts/backups" -Force | Out-Null
          New-Item -ItemType Directory -Path "artifacts/logs" -Force | Out-Null
          Write-Host "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏–º—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: $env:CONFIG_NAME"

      - name: –°–±–æ—Ä–∫–∞ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ ‚Üí CF
        shell: pwsh
        run: |
          pwsh -File scripts/build-1c.ps1 `
            -Platform "$env:ONEC_PLATFORM" `
            -Storage "$env:STORAGE" `
            -StorageUser "$env:STORAGE_USER" `
            -StoragePwd "$env:STORAGE_PWD" `
            -OutCf "artifacts/build/${{ env.CONFIG_NAME }}.cf"

      - name: –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è CF
        shell: pwsh
        run: |
          pwsh -File scripts/simple-build.ps1 `
            -Source "artifacts/build/${{ env.CONFIG_NAME }}.cf" `
            -BackupDir "artifacts/backups" `
            -Prefix "${{ env.CONFIG_NAME }}"

      - name: –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        uses: actions/upload-artifact@v4
        with:
          name: 1c-configuration-${{ github.run_id }}
          path: artifacts/
          retention-days: 30

  test_deploy:
    name: üß™ –¢–µ—Å—Ç + –î–µ–ø–ª–æ–π
    runs-on: windows-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: –°–∫–∞—á–∞—Ç—å –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
        uses: actions/download-artifact@v4
        with:
          name: 1c-configuration-${{ github.run_id }}
          path: artifacts
          merge-multiple: false

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ CF
        shell: pwsh
        run: |
          if (-not (Test-Path "artifacts/build/${{ env.CONFIG_NAME }}.cf")) { Write-Error "CF not found"; exit 1 }
          Write-Host "–ù–∞–π–¥–µ–Ω CF-—Ñ–∞–π–ª: ${{ env.CONFIG_NAME }}.cf"
          Get-ChildItem -Recurse artifacts | Format-Table FullName

      - name: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ò–ë (–¥–µ–ø–ª–æ–π)
        shell: pwsh
        run: |
          pwsh -File scripts/deploy-1c.ps1 `
            -Platform "$env:ONEC_PLATFORM" `
            -Infobase "$env:TEST_IB_CONN" `
            -IBUser "$env:TEST_IB_USER" `
            -IBPwd "$env:TEST_IB_PWD" `
            -Cf "artifacts/build/${{ env.CONFIG_NAME }}.cf"

      - name: Smoke-—Ç–µ—Å—Ç –ò–ë
        shell: pwsh
        run: |
          pwsh -File scripts/tests/smoke.ps1 `
            -Platform "$env:ONEC_PLATFORM" `
            -Infobase "$env:TEST_IB_CONN" `
            -IBUser "$env:TEST_IB_USER" `
            -IBPwd "$env:TEST_IB_PWD"

      - name: –õ–æ–≥–∏ –¥–µ–ø–ª–æ—è
        if: always()
        shell: pwsh
        run: |
          $status = if ($LASTEXITCODE -eq 0) { "SUCCESS" } else { "FAIL" }
          $log = "artifacts/logs/deploy-$($env:GITHUB_RUN_ID).log"
          @"
          ==============================================
          1C CI/CD Pipeline Deployment Log
          ==============================================
          Configuration: $env:CONFIG_NAME
          Status: $status
          Run ID: $env:GITHUB_RUN_ID
          Branch: $env:GITHUB_REF_NAME
          Commit: $env:GITHUB_SHA
          Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          ==============================================
          "@ | Out-File $log -Encoding UTF8
          Get-Content $log

      - name: –ê—Ä—Ç–µ—Ñ–∞–∫—Ç –ª–æ–≥–æ–≤
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_id }}
          path: artifacts/logs/
          retention-days: 7
