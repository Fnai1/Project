name: 1C CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CONFIG_NAME: "andreym"

jobs:
  build:
    name: 🔨 Сборка конфигурации
    runs-on: windows-latest
    
    steps:
      - name: Checkout кода
        uses: actions/checkout@v4
        
      - name: Подготовка окружения
        shell: pwsh
        run: |
          # Создаем структуру каталогов
          Write-Host "Создание структуры каталогов..."
          New-Item -ItemType Directory -Path "artifacts" -Force
          New-Item -ItemType Directory -Path "artifacts/build" -Force
          New-Item -ItemType Directory -Path "artifacts/backups" -Force
          New-Item -ItemType Directory -Path "artifacts/logs" -Force
          Write-Host "✅ Структура создана"
          
      - name: Создать CF файл конфигурации
        shell: pwsh
        run: |
          $cfPath = "artifacts/build/andreym.cf"
          $version = "$(Get-Date -Format 'yyyy.MM.dd').${{ github.run_number }}"
          
          Write-Host "Создание CF файла: $cfPath"
          
          # Создаем контент без here-string
          $lines = @(
            "# Конфигурация 1C",
            "Название: andreym",
            "Версия: $version",
            "Дата сборки: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
            "Сборка: ${{ github.run_id }}",
            "Ветка: ${{ github.ref_name }}",
            "Автор: ${{ github.actor }}"
          )
          
          $lines | Out-File -FilePath $cfPath -Encoding UTF8
          
          Write-Host "✅ CF файл создан: $cfPath"
          Write-Host "📏 Размер: $((Get-Item $cfPath).Length) байт"
          
      - name: Создать резервную копию
        shell: pwsh
        run: |
          $timestamp = Get-Date -Format "yyyyMMdd-HHmmss"
          $source = "artifacts/build/andreym.cf"
          $backup = "artifacts/backups/andreym-$timestamp.cf"
          
          Copy-Item -Path $source -Destination $backup
          Write-Host "✅ Резервная копия: $backup"
          
      - name: Загрузить артефакты
        uses: actions/upload-artifact@v4
        with:
          name: 1c-configuration-${{ github.run_id }}
          path: artifacts/
          retention-days: 30

  deploy:
    name: 🚀 Деплой
    runs-on: windows-latest
    needs: build
    if: github.ref == "refs/heads/main"
    
    steps:
      - name: Checkout кода
        uses: actions/checkout@v4
        
      - name: Загрузить артефакты
        uses: actions/download-artifact@v4
        with:
          name: 1c-configuration-${{ github.run_id }}
          path: .  # Загружаем в корень рабочей директории
          
      - name: Создать папку для логов (если не существует)
        shell: pwsh
        run: |
          # Убедимся что папка logs существует
          if (!(Test-Path "artifacts/logs")) {
            New-Item -ItemType Directory -Path "artifacts/logs" -Force
            Write-Host "✅ Папка logs создана"
          }
          
      - name: Проверить конфигурацию
        shell: pwsh
        run: |
          Write-Host "🔍 Проверка собранной конфигурации..."
          Write-Host "Текущая директория: $(Get-Location)"
          Write-Host "Содержимое artifacts:"
          Get-ChildItem -Path "artifacts" -Recurse -ErrorAction SilentlyContinue | Format-Table FullName
          
          $cfFile = "artifacts/build/andreym.cf"
          if (Test-Path $cfFile) {
            Write-Host "✅ CF файл найден"
            Write-Host "--- Содержимое ---"
            Get-Content $cfFile
            Write-Host "-----------------"
          } else {
            Write-Host "❌ CF файл не найден"
            # Ищем файлы где угодно
            Write-Host "Поиск всех .cf файлов:"
            Get-ChildItem -Path "." -Recurse -Filter "*.cf" -ErrorAction SilentlyContinue
            exit 1
          }
          
      - name: Деплой на тестовый сервер (заглушка)
        shell: pwsh
        run: |
          Write-Host "🚀 Имитация деплоя на сервер 1C..."
          Write-Host "📄 Используется файл: artifacts/build/andreym.cf"
          Write-Host "✅ Деплой выполнен успешно (тестовый режим)"
          
      - name: Создать лог выполнения
        shell: pwsh
        if: always()
        run: |
          Write-Host "📝 Создание лога выполнения..."
          
          # Получаем статус выполнения
          if ($LASTEXITCODE -eq 0) {
            $status = "УСПЕХ"
          } else {
            $status = "ОШИБКА"
          }
          
          # Создаем папку если её нет
          $logDir = "artifacts/logs"
          if (!(Test-Path $logDir)) {
            New-Item -ItemType Directory -Path $logDir -Force
          }
          
          # Создаем лог
          $logFile = "$logDir/deploy-${{ github.run_id }}.log"
          $logContent = @(
            "1C CI/CD Лог выполнения",
            "=======================",
            "Запуск: ${{ github.run_id }}",
            "Ветка: ${{ github.ref_name }}",
            "Статус: $status",
            "Время: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')",
            "Конфигурация: ${{ env.CONFIG_NAME }}"
          )
          
          $logContent | Out-File -FilePath $logFile -Encoding UTF8
          Write-Host "✅ Лог сохранен: $logFile"
          Write-Host "Содержимое лога:"
          Get-Content $logFile
          
      - name: Загрузить лог как артефакт
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_id }}
          path: artifacts/logs/
          retention-days: 7
