name: 1C CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  CONFIG_NAME: "andreym"
  ONEC_PLATFORM: ${{ secrets.ONEC_PLATFORM }}
  STORAGE: ${{ secrets.STORAGE }}
  STORAGE_USER: ${{ secrets.STORAGE_USER }}
  STORAGE_PWD: ${{ secrets.STORAGE_PWD }}
  TEST_IB_CONN: ${{ secrets.TEST_IB_CONN }}
  TEST_IB_USER: ${{ secrets.TEST_IB_USER }}
  TEST_IB_PWD: ${{ secrets.TEST_IB_PWD }}
  PUBLISH_URL: ${{ secrets.PUBLISH_URL }}

jobs:
  build:
    name: 🔨 Сборка конфигурации
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Подготовка каталогов
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path "artifacts/build" -Force | Out-Null
          New-Item -ItemType Directory -Path "artifacts/backups" -Force | Out-Null
          New-Item -ItemType Directory -Path "artifacts/logs" -Force | Out-Null

      - name: Сборка из хранилища → CF
        shell: pwsh
        run: |
          pwsh -File scripts/build-1c.ps1 `
            -Platform "$env:ONEC_PLATFORM" `
            -Storage "$env:STORAGE" `
            -StorageUser "$env:STORAGE_USER" `
            -StoragePwd "$env:STORAGE_PWD" `
            -OutCf "artifacts/build/${{ env.CONFIG_NAME }}.cf"

      - name: Резервная копия CF
        shell: pwsh
        run: |
          pwsh -File scripts/simple-build.ps1 -Source "artifacts/build/${{ env.CONFIG_NAME }}.cf" -BackupDir "artifacts/backups"

      - name: Загрузить артефакты
        uses: actions/upload-artifact@v4
        with:
          name: 1c-configuration-${{ github.run_id }}
          path: artifacts/
          retention-days: 30

  test_deploy:
    name: 🧪 Тест + Деплой
    runs-on: windows-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Скачать артефакты
        uses: actions/download-artifact@v4
        with:
          name: 1c-configuration-${{ github.run_id }}
          path: artifacts
          merge-multiple: false

      - name: Проверка CF
        shell: pwsh
        run: |
          if (-not (Test-Path "artifacts/build/${{ env.CONFIG_NAME }}.cf")) { Write-Error "CF not found"; exit 1 }
          Get-ChildItem -Recurse artifacts | Format-Table FullName

      - name: Обновление ИБ (деплой)
        shell: pwsh
        run: |
          pwsh -File scripts/deploy-1c.ps1 `
            -Platform "$env:ONEC_PLATFORM" `
            -Infobase "$env:TEST_IB_CONN" `
            -IBUser "$env:TEST_IB_USER" `
            -IBPwd "$env:TEST_IB_PWD" `
            -Cf "artifacts/build/${{ env.CONFIG_NAME }}.cf"

      - name: Smoke-тест ИБ
        shell: pwsh
        run: |
          pwsh -File scripts/tests/smoke.ps1 `
            -Platform "$env:ONEC_PLATFORM" `
            -Infobase "$env:TEST_IB_CONN" `
            -IBUser "$env:TEST_IB_USER" `
            -IBPwd "$env:TEST_IB_PWD"

      - name: Логи деплоя
        if: always()
        shell: pwsh
        run: |
          $status = if ($LASTEXITCODE -eq 0) { "SUCCESS" } else { "FAIL" }
          $log = "artifacts/logs/deploy-$($env:GITHUB_RUN_ID).log"
          "Status: $status`nTime: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')" | Out-File $log -Encoding UTF8
          Get-Content $log

      - name: Артефакт логов
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deployment-logs-${{ github.run_id }}
          path: artifacts/logs/
          retention-days: 7
