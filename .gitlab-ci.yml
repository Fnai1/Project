image: mcr.microsoft.com/windows/servercore:ltsc2019

variables:
  CONFIG_NAME: "andreym"
  PROJECT_NAME: "andreymatanin-1c-project"
  ARTIFACTS_DIR: "artifacts"
  BUILD_DIR: "$ARTIFACTS_DIR/build"
  BACKUP_DIR: "$ARTIFACTS_DIR/backups"
  SCRIPTS_DIR: "scripts"
  LOGS_DIR: "$ARTIFACTS_DIR/logs"
  SHELL: "powershell"

cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - "$ARTIFACTS_DIR/cache/"
  policy: pull-push

stages:
  - init
  - build
  - test

workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        DEPLOY_ENV: "production"
    - if: '$CI_COMMIT_BRANCH == "develop"'
      variables:
        DEPLOY_ENV: "staging"
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'

init-stage:
  stage: init
  tags:
    - windows
  script:
    - echo "Initializing 1C CI/CD Pipeline"
    - echo "Configuration: $CONFIG_NAME"
    - mkdir -p "$BUILD_DIR"
    - mkdir -p "$BACKUP_DIR"
    - mkdir -p "$LOGS_DIR"
    - echo "Directories created successfully"
  artifacts:
    paths:
      - "$ARTIFACTS_DIR/"
    expire_in: 1 day

build-stage:
  stage: build
  tags:
    - windows
  script:
    - echo "Building 1C configuration: $CONFIG_NAME"
    - echo "Creating CF file..."
    - echo "1C Configuration File: $CONFIG_NAME" > "$BUILD_DIR/$CONFIG_NAME.cf"
    - echo "Version: 1.0" >> "$BUILD_DIR/$CONFIG_NAME.cf"
    - echo "Date: created via GitLab CI" >> "$BUILD_DIR/$CONFIG_NAME.cf"
    - echo "Build completed successfully"
  artifacts:
    paths:
      - "$BUILD_DIR/*.cf"
    expire_in: 30 days
  only:
    - main
    - develop

test-stage:
  stage: test
  tags:
    - windows
  script:
    - echo "Testing configuration: $CONFIG_NAME"
    - echo "Checking if CF file exists..."
    - if exist "$BUILD_DIR/$CONFIG_NAME.cf" (
        echo "Test passed: CF file found"
      ) else (
        echo "Test failed: CF file not found" && exit 1
      )
    - echo "All tests completed successfully"
  needs: ["build-stage"]
  only:
    - main
    - develop
