# GitLab CI/CD Pipeline for 1C Enterprise
# Project: andreymatanin-group/andreymatanin-project

# Use Windows Docker image
image: mcr.microsoft.com/windows/servercore:ltsc2019

# Global variables
variables:
  # Configuration settings
  CONFIG_NAME: "andreym"         
  PROJECT_NAME: "andreymatanin-1c-project"
  
  # Directory structure
  ARTIFACTS_DIR: "artifacts"
  BUILD_DIR: "$ARTIFACTS_DIR/build"
  BACKUP_DIR: "$ARTIFACTS_DIR/backups"
  SCRIPTS_DIR: "scripts"
  LOGS_DIR: "$ARTIFACTS_DIR/logs"
  
  # Windows settings
  SHELL: "powershell"
  CMD: "cmd"

# Cache configuration
cache:
  key: "${CI_COMMIT_REF_SLUG}"
  paths:
    - $ARTIFACTS_DIR/cache/
  policy: pull-push

# Pipeline stages
stages:
  - init
  - validate
  - build
  - test
  - deploy-test
  - deploy-prod
  - notify

# Workflow rules
workflow:
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      variables:
        DEPLOY_ENV: "production"
    - if: '$CI_COMMIT_BRANCH == "develop"'
      variables:
        DEPLOY_ENV: "staging"
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_TAG'

# Common before_script for all jobs
.before_script: &before_script
  before_script:
    - echo "========================================"
    - echo "Pipeline: $CI_PIPELINE_ID"
    - echo "Job: $CI_JOB_NAME"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Config: $CONFIG_NAME"
    - echo "Environment: $DEPLOY_ENV"
    - echo "========================================"
    - mkdir -p $BUILD_DIR
    - mkdir -p $BACKUP_DIR
    - mkdir -p $LOGS_DIR
    - echo "Directories created successfully"

# Common tags for Windows runner
.tags: &tags
  tags:
    - windows
    - 1c
    - docker

# ==================== STAGE: INIT ====================
init-pipeline:
  stage: init
  <<: *tags
  script:
    - echo "Initializing 1C CI/CD Pipeline"
    - echo "Checking system information..."
    - systeminfo | findstr /C:"OS Name" /C:"OS Version"
    - echo "Checking disk space..."
    - wmic logicaldisk get size,freespace,caption
    - echo "Checking 1C availability..."
    - if exist "C:\host\1c\1CEStart\bin\designer.exe" (
        echo "SUCCESS: 1C Designer found at C:\host\1c\1CEStart\bin\designer.exe"
      ) else (
        echo "WARNING: 1C Designer not found in default location"
        echo "Please mount 1C to C:\host\1c"
      )
    - echo "Initialization completed"
  artifacts:
    paths:
      - $LOGS_DIR/
    expire_in: 1 day
  except:
    - tags

# ==================== STAGE: VALIDATE ====================
validate-project:
  stage: validate
  <<: *tags
  <<: *before_script
  script:
    - echo "Validating project structure..."
    
    # Check required directories
    - echo "Checking required directories:"
    - if not exist "$SCRIPTS_DIR" (mkdir "$SCRIPTS_DIR")
    - if not exist "$ARTIFACTS_DIR" (mkdir "$ARTIFACTS_DIR")
    - if not exist "$SCRIPTS_DIR" (echo "ERROR: scripts directory missing" && exit 1)
    - if not exist "$ARTIFACTS_DIR" (echo "ERROR: artifacts directory missing" && exit 1)
    - echo "Directories: OK"
    
    # Check for scripts
    - echo "Checking for PowerShell scripts..."
    - if exist "$SCRIPTS_DIR\*.ps1" (
        echo "Found PowerShell scripts:"
        dir "$SCRIPTS_DIR\*.ps1" /b
      ) else (
        echo "WARNING: No PowerShell scripts found in scripts directory"
      )
    
    # Check .gitlab-ci.yml
    - echo "Checking .gitlab-ci.yml..."
    - if exist ".gitlab-ci.yml" (
        echo ".gitlab-ci.yml exists"
      ) else (
        echo "ERROR: .gitlab-ci.yml not found" && exit 1
      )
    
    - echo "Validation completed successfully"
  artifacts:
    paths:
      - $LOGS_DIR/validation.log
    expire_in: 1 week
  only:
    - main
    - develop
    - merge_requests

# ==================== STAGE: BUILD ====================
build-configuration:
  stage: build
  <<: *tags
  <<: *before_script
  script:
    - echo "Building 1C configuration: $CONFIG_NAME"
    
    # Create timestamp for backup
    - for /f "tokens=2 delims==" %%I in ('wmic os get localdatetime /value') do set datetime=%%I
    - set timestamp=%datetime:~0,4%%datetime:~4,2%%datetime:~6,2%_%datetime:~8,2%%datetime:~10,2%
    
    # Step 1: Display build info
    - echo "Step 1: Build information"
    - echo "  Configuration: $CONFIG_NAME"
    - echo "  Repository: %V8_REPOSITORY_PATH%"
    - echo "  Output: $BUILD_DIR\$CONFIG_NAME.cf"
    
    # Step 2: Simulate getting configuration from repository
    - echo "Step 2: Getting configuration from repository (simulated)"
    - timeout /t 3 /nobreak > nul
    - echo "  Repository connection: OK"
    
    # Step 3: Simulate building CF file
    - echo "Step 3: Building CF file (simulated)"
    - echo "# 1C Configuration File" > "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "# Generated by GitLab CI/CD" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "Name: $CONFIG_NAME" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "Version: 1.0.$CI_PIPELINE_IID" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "Date: %DATE% %TIME%" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "Commit: $CI_COMMIT_SHA" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "Branch: $CI_COMMIT_REF_NAME" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    - echo "Project: $PROJECT_NAME" >> "$BUILD_DIR\$CONFIG_NAME.cf"
    
    # Step 4: Create backup
    - echo "Step 4: Creating backup"
    - copy "$BUILD_DIR\$CONFIG_NAME.cf" "$BACKUP_DIR\$CONFIG_NAME_%timestamp%.cf"
    - echo "  Backup created: $BACKUP_DIR\$CONFIG_NAME_%timestamp%.cf"
    
    # Step 5: Display results
    - echo "Step 5: Build results"
    - echo "  File created: $BUILD_DIR\$CONFIG_NAME.cf"
    - dir "$BUILD_DIR\$CONFIG_NAME.cf"
    
    - echo "Build simulation completed successfully"
    
  artifacts:
    paths:
      - $BUILD_DIR/*.cf
      - $BACKUP_DIR/*.cf
    when: always
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests

# ==================== STAGE: TEST ====================
test-configuration:
  stage: test
  <<: *tags
  <<: *before_script
  script:
    - echo "Testing configuration: $CONFIG_NAME"
    
    # Test 1: Check if CF file exists
    - echo "Test 1: Checking CF file existence"
    - if not exist "$BUILD_DIR\$CONFIG_NAME.cf" (
        echo "FAIL: CF file not found at $BUILD_DIR\$CONFIG_NAME.cf"
        exit 1
      )
    - echo "PASS: CF file exists"
    
    # Test 2: Check file size
    - echo "Test 2: Checking file size"
    - for /f %%i in ('dir /-c "$BUILD_DIR\$CONFIG_NAME.cf" ^| find "1 File(s)"') do set size=%%i
    - if %size% LSS 50 (
        echo "FAIL: CF file is too small (%size% bytes)"
        exit 1
      )
    - echo "PASS: File size is acceptable (%size% bytes)"
    
    # Test 3: Check file content
    - echo "Test 3: Checking file content"
    - findstr /C:"1C Configuration File" "$BUILD_DIR\$CONFIG_NAME.cf" > nul
    - if errorlevel 1 (
        echo "FAIL: Invalid CF file format"
        exit 1
      )
    - echo "PASS: Valid CF file format"
    
    # Test 4: Display file info
    - echo "Test 4: File information"
    - echo "  Path: $BUILD_DIR\$CONFIG_NAME.cf"
    - echo "  First 5 lines:"
    - type "$BUILD_DIR\$CONFIG_NAME.cf" | head -5
    
    - echo "All tests passed successfully"
    
  artifacts:
    paths:
      - $LOGS_DIR/test.log
    when: always
    expire_in: 1 week
  needs: ["build-configuration"]
  only:
    - main
    - develop

# ==================== STAGE: DEPLOY-TEST ====================
deploy-to-test:
  stage: deploy-test
  <<: *tags
  <<: *before_script
  environment:
    name: test/$CONFIG_NAME
    url: http://${V8_TEST_SERVER}:1540
  script:
    - echo "========================================"
    - echo "DEPLOYING TO TEST ENVIRONMENT"
    - echo "========================================"
    - echo "Configuration: $CONFIG_NAME"
    - echo "Server: %V8_TEST_SERVER%"
    - echo "Infobase: ${CONFIG_NAME}_TEST"
    - echo "CF File: $BUILD_DIR\$CONFIG_NAME.cf"
    - echo ""
    - echo "WARNING: This is a simulation"
    - echo "Real deployment requires:"
    - echo "  1. V8_TEST_SERVER variable set"
    - echo "  2. V8_TEST_USER variable set"
    - echo "  3. V8_TEST_PASS variable set"
    - echo "  4. 1C COM access"
    - echo ""
    - echo "Starting deployment simulation..."
    - timeout /t 10 /nobreak > nul
    - echo ""
    - echo "Simulation steps:"
    - echo "  1. Connect to 1C server: %V8_TEST_SERVER%"
    - echo "  2. Open infobase: ${CONFIG_NAME}_TEST"
    - echo "  3. Load configuration: $BUILD_DIR\$CONFIG_NAME.cf"
    - echo "  4. Update database configuration"
    - echo "  5. Verify deployment"
    - echo ""
    - echo "Test deployment simulation completed"
    - echo "Note: To enable real deployment, set the required variables"
  needs: ["test-configuration"]
  when: manual
  only:
    - develop
  dependencies:
    - build-configuration
  allow_failure: false

# ==================== STAGE: DEPLOY-PROD ====================
deploy-to-production:
  stage: deploy-prod
  <<: *tags
  <<: *before_script
  environment:
    name: production/$CONFIG_NAME
    url: http://${V8_PROD_SERVER}:1540
  script:
    - echo "========================================"
    - echo "üöÄ PRODUCTION DEPLOYMENT üöÄ"
    - echo "========================================"
    - echo "WARNING: THIS WILL DEPLOY TO PRODUCTION"
    - echo "Ensure you have:"
    - echo "  1. All tests passed"
    - echo "  2. Approval from team lead"
    - echo "  3. Backup of current configuration"
    - echo "  4. Maintenance window scheduled"
    - echo ""
    - echo "Deployment details:"
    - echo "  Configuration: $CONFIG_NAME"
    - echo "  Server: %V8_PROD_SERVER%"
    - echo "  Infobase: $CONFIG_NAME"
    - echo "  CF File: $BUILD_DIR\$CONFIG_NAME.cf"
    - echo "  Commit: $CI_COMMIT_SHA"
    - echo "  Branch: $CI_COMMIT_REF_NAME"
    - echo "  User: $GITLAB_USER_NAME"
    - echo ""
    - echo "Starting deployment simulation..."
    - timeout /t 15 /nobreak > nul
    - echo ""
    - echo "Simulation steps:"
    - echo "  1. Create backup of current production configuration"
    - echo "  2. Connect to production server: %V8_PROD_SERVER%"
    - echo "  3. Load new configuration"
    - echo "  4. Update database"
    - echo "  5. Run post-deployment tests"
    - echo "  6. Notify team"
    - echo ""
    - echo "Production deployment simulation completed"
    - echo ""
    - echo "‚ö†Ô∏è  IMPORTANT: This was a simulation"
    - echo "Real deployment requires proper setup and variables"
  needs: ["test-configuration"]
  when: manual
  only:
    - main
  dependencies:
    - build-configuration
  allow_failure: false

# ==================== STAGE: NOTIFY ====================
notify-success:
  stage: notify
  <<: *tags
  script:
    - echo "========================================"
    - echo "SUCCESS NOTIFICATION"
    - echo "========================================"
    - echo "Pipeline: $CI_PIPELINE_URL"
    - echo "Status: SUCCESS ‚úÖ"
    - echo "Project: $CI_PROJECT_TITLE"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Commit: ${CI_COMMIT_SHA:0:8}"
    - echo "Author: $CI_COMMIT_AUTHOR"
    - echo "Duration: $CI_JOB_DURATION seconds"
    - echo ""
    - echo "Jobs completed:"
    - echo "  - init-pipeline"
    - echo "  - validate-project"
    - echo "  - build-configuration"
    - echo "  - test-configuration"
    - echo ""
    - echo "Next steps:"
    - echo "  1. Review artifacts"
    - echo "  2. Deploy to test (manual)"
    - echo "  3. Deploy to production (manual)"
    - echo ""
    - echo "Notifications would be sent to:"
    - echo "  - Slack/Teams channel"
    - echo "  - Email list"
    - echo "  - Monitoring system"
  when: on_success

notify-failure:
  stage: notify
  <<: *tags
  script:
    - echo "========================================"
    - echo "FAILURE NOTIFICATION"
    - echo "========================================"
    - echo "Pipeline: $CI_PIPELINE_URL"
    - echo "Status: FAILED ‚ùå"
    - echo "Project: $CI_PROJECT_TITLE"
    - echo "Branch: $CI_COMMIT_REF_NAME"
    - echo "Failed job: $CI_JOB_NAME"
    - echo "Job URL: $CI_JOB_URL"
    - echo "Commit: ${CI_COMMIT_SHA:0:8}"
    - echo "Author: $CI_COMMIT_AUTHOR"
    - echo ""
    - echo "Possible issues:"
    - echo "  1. Missing variables"
    - echo "  2. 1C Designer not accessible"
    - echo "  3. Script errors"
    - echo "  4. Network issues"
    - echo ""
    - echo "Immediate actions:"
    - echo "  1. Check job logs"
    - echo "  2. Verify runner connectivity"
    - echo "  3. Check variable values"
    - echo ""
    - echo "Failure notifications would be sent with high priority"
  when: on_failure

# ==================== SPECIAL JOBS ====================
manual-rollback:
  stage: deploy-prod
  <<: *tags
  environment:
    name: production/$CONFIG_NAME
    url: http://${V8_PROD_SERVER}:1540
    action: stop
  script:
    - echo "========================================"
    - echo "MANUAL ROLLBACK"
    - echo "========================================"
    - echo "Initiator: $GITLAB_USER_NAME"
    - echo "Email: $GITLAB_USER_EMAIL"
    - echo "Time: %DATE% %TIME%"
    - echo "Environment: production"
    - echo "Configuration: $CONFIG_NAME"
    - echo ""
    - echo "Checking available backups..."
    - echo "Backup directory: $BACKUP_DIR"
    - dir "$BACKUP_DIR" /b /o-d
    - echo ""
    - echo "Rollback simulation steps:"
    - echo "  1. Identify latest backup"
    - echo "  2. Stop production services"
    - echo "  3. Restore from backup"
    - echo "  4. Start services"
    - echo "  5. Verify restoration"
    - echo ""
    - timeout /t 10 /nobreak > nul
    - echo "Rollback simulation completed"
    - echo ""
    - echo "‚ö†Ô∏è  This was a simulation"
    - echo "Real rollback requires proper backup files"
  when: manual
  allow_failure: false
  only:
    - main
    - develop

cleanup-old-artifacts:
  stage: .post  # Special stage that runs last
  <<: *tags
  script:
    - echo "Cleaning up old artifacts..."
    - echo "Current artifacts size:"
    - dir "$ARTIFACTS_DIR" /s
    - echo ""
    - echo "This job would:"
    - echo "  1. Delete backups older than 90 days"
    - echo "  2. Delete build artifacts older than 30 days"
    - echo "  3. Delete logs older than 7 days"
    - echo ""
    - echo "Cleanup simulation completed"
  when: always
  except:
    - tags